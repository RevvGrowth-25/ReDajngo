{% extends "base.html" %}
{% block title %}AI Dept â€“ Executive Dashboard{% endblock %}

{% block content %}
<!-- Hero Stats -->
<section class="pt-8 pb-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Performance Overview</h2>
        <p class="text-gray-600">Real-time metrics and automation insights</p>
      </div>
      <div class="text-right hidden md:block">
        <div class="text-sm text-gray-500">Last Updated</div>
        <div class="text-sm font-semibold text-gray-700">{{ data.metadata.last_updated }}</div>
      </div>
    </div>



    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="kpiRow"></div>
  </div>
</section>

<!-- Quick Insights Banner -->
<section class="py-4">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-gradient-to-r from-brand-600 to-accent-600 rounded-2xl p-6 shadow-lg text-white">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur"><i class="fas fa-trophy text-2xl"></i></div>
          <div>
            <div class="text-sm opacity-90">Average Accuracy</div>
            <div class="text-2xl font-bold">{{ data.metadata.avg_accuracy }}%</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur"><i class="fas fa-database text-2xl"></i></div>
          <div>
            <div class="text-sm opacity-90">Total Departments</div>
            <div class="text-2xl font-bold">{{ data.metadata.total_Department }}</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur"><i class="fas fa-bolt text-2xl"></i></div>
          <div>
            <div class="text-sm opacity-90">Active Processes</div>
            <div class="text-2xl font-bold">{{ data.metadata.total_processes }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Charts -->
<section class="py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Bar Chart -->
      <div class="lg:col-span-2 bg-white rounded-2xl p-6 card shadow-md">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-chart-bar text-brand-600"></i>Process Area Performance</h3>
            <p class="text-sm text-gray-500 mt-1">Department-wise project distribution</p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold metric-number" id="totalBarHours">0</div>
            <div class="text-xs text-gray-500 font-medium">Total Projects</div>
          </div>
        </div>
        <div class="h-[280px]"><canvas id="barChart"></canvas></div>
      </div>

      <!-- Pie Chart -->
      <div class="bg-white rounded-2xl p-6 card shadow-md">
        <div class="mb-4">
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-chart-pie text-accent-600"></i>Team Contribution</h3>
          <p class="text-sm text-gray-500 mt-1">Distribution of work</p>
        </div>
        <div class="h-[280px] flex items-center justify-center"><canvas id="pieChart"></canvas></div>
      </div>
    </div>
  </div>
</section>

<!-- Line Chart -->
<section class="py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-2xl p-6 card shadow-md">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-chart-line text-brand-600"></i>Monthly Efficiency Trend</h3>
          <p class="text-sm text-gray-500 mt-1">Tracking project over months</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-center px-4 py-2 bg-green-50 rounded-lg border border-green-200">
            <div class="text-xs text-green-600 font-semibold">Leave Count</div>
            <div class="text-lg font-bold text-green-700" id="trendGrowth"> </div>
          </div>
          <div class="text-center px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
            <div class="text-xs text-blue-600 font-semibold">Current Month</div>
            <div class="text-lg font-bold text-blue-700" id="currentMonth">0</div>
          </div>
        </div>
      </div>
      <div class="h-[300px]"><canvas id="lineChart"></canvas></div>
    </div>
  </div>
</section>

<!-- Production Automations Table -->
<section class="py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-2xl p-6 card shadow-md">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
        <div>
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-robot text-brand-600"></i>Production Automations</h3>
          <p class="text-sm text-gray-500 mt-1">Detailed breakdown of active automation systems</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg border border-green-200">
            <i class="fas fa-check-circle text-green-600"></i>
            <span class="text-sm font-semibold text-green-700" id="liveCount">0 Live</span>
          </div>
          <div class="flex items-center gap-2 bg-amber-50 px-4 py-2 rounded-lg border border-amber-200">
            <i class="fas fa-flask text-amber-600"></i>
            <span class="text-sm font-semibold text-amber-700" id="testingCount">0 Testing</span>
          </div>
        </div>
      </div>

      <!-- Search & Status Filter -->
      <div class="mb-4 flex items-center gap-3">
        <div class="flex-1">
          <input type="text" id="searchTable" placeholder="Search processes..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm">
        </div>
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm">
          <option value="all">All Status</option>
          <option value="Live">Live Only</option>
          <option value="Testing">Testing Only</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Process Name</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Owner</th>
              <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:text-brand-600" onclick="sortTable('Department')">
                Department <i class="fas fa-sort text-xs ml-1"></i>
              </th>
              <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:text-brand-600" onclick="sortTable('hrsSaved')">
                Project <i class="fas fa-sort text-xs ml-1"></i>
              </th>
              <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:text-brand-600" onclick="sortTable('accuracy')">
                Accuracy <i class="fas fa-sort text-xs ml-1"></i>
              </th>
              <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody id="detailTableBody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="mt-4 text-sm text-gray-500 text-center" id="tableInfo">
        Showing <span id="rowCount" class="font-semibold">0</span> processes
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const dashboardData = {{ data|safe }};
  let currentUser = 'all';
  let allRows   = [...dashboardData.rows];
  let filteredRows = [...allRows];
  const sortDirection = { Department: 'desc', hrsSaved: 'desc', accuracy: 'desc' };

  const colors = {
    brand: ['#0284c7','#0369a1','#075985','#0c4a6e','#38bdf8'],
    accent:['#9333ea','#7e22ce','#6b21a8','#581c87','#a855f7'],
    gradient:{ brand:'rgba(2,132,199,0.8)', brandLight:'rgba(2,132,199,0.2)', accent:'rgba(147,51,234,0.8)', accentLight:'rgba(147,51,234,0.2)' }
  };

  const barCtx = document.getElementById('barChart').getContext('2d');
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  let barChart, pieChart, lineChart;

  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = '#6b7280';

  /* ---------- helpers ---------- */
  function getData(){
  return {
    kpi: dashboardData.kpi[currentUser],
    bar: dashboardData.bar[currentUser],
    pie: dashboardData.pie[currentUser],
    line: dashboardData.line[currentUser],
    rows: currentUser === 'all'
      ? filteredRows
      : filteredRows.filter(r =>
          r.owner.toLowerCase().includes(currentUser.toLowerCase())
        )
  };
}

  /* ---------- KPI cards ---------- */
  function renderKPI(){
    const d = getData();
    const items = [
      {label:'Automations Built', value:d.kpi.automations, icon:'fa-robot', gradient:'from-blue-500 to-cyan-500', bgGradient:'from-blue-50 to-cyan-50'},
      {label:'Handover Done', value:d.kpi.handover, icon:'fa-handshake', gradient:'from-purple-500 to-pink-500', bgGradient:'from-purple-50 to-pink-50'},
      {label:'Hours Saved', value:d.kpi.hrsSaved.toLocaleString('en-IN'), icon:'fa-clock', gradient:'from-green-500 to-emerald-500', bgGradient:'from-green-50 to-emerald-50'},
      {label:'In Production', value:d.kpi.production, icon:'fa-check-circle', gradient:'from-orange-500 to-red-500', bgGradient:'from-orange-50 to-red-50'}
    ];
    document.getElementById('kpiRow').innerHTML = items.map(it =>
      `<div class="relative overflow-hidden bg-gradient-to-br ${it.bgGradient} rounded-2xl p-6 card shadow-md border border-white">
        <div class="relative z-10">
          <div class="flex items-center justify-between mb-3">
            <div class="w-12 h-12 bg-gradient-to-br ${it.gradient} rounded-xl flex items-center justify-center shadow-lg">
              <i class="fas ${it.icon} text-white text-lg"></i>
            </div>
          </div>
          <div class="text-3xl font-bold metric-number mb-1">${it.value}</div>
          <div class="text-sm font-medium text-gray-600">${it.label}</div>
        </div>
        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/30 rounded-full blur-2xl"></div>
      </div>`).join('');
  }

  /* ---------- charts ---------- */
  function renderCharts(){
    const d = getData();
    const totalBar = d.bar.data.reduce((a,b)=>a+b,0);
    document.getElementById('totalBarHours').textContent = totalBar.toLocaleString('en-IN');
    const lineData = d.line.data;
    const allLeaves = [0, 0, 1, 1, 0, 2, 1, 0, 1, 2];
const ayushLeaves = [0, 0, 1, 1, 2, 1, 0, 1, 2, 0];
const divyaLeaves = [0, 0, 0, 0, 0, 0, 1, 1, 1, 1];

const ayushTotal = ayushLeaves.reduce((a, b) => a + b, 0);
const divyaTotal = divyaLeaves.reduce((a, b) => a + b, 0);

// if (leaveBreakupEl) leaveBreakupEl.textContent = `Ayush: ${ayushTotal} | Divya: ${divyaTotal}`;

    if(lineData.length>=2){
      const growth = ((lineData[lineData.length-1]-lineData[0])/lineData[0]*100).toFixed(1);
      document.getElementById('trendGrowth').textContent = `Ayush: ${ayushTotal} | Divya: ${divyaTotal}`;
      document.getElementById('currentMonth').textContent = lineData[lineData.length-1].toLocaleString('en-IN');
    }

    if(barChart) barChart.destroy();
    if(pieChart) pieChart.destroy();
    if(lineChart) lineChart.destroy();

    barChart = new Chart(barCtx, {
      type:'bar',
      data:{
        labels:d.bar.labels,
        datasets:[{
          label:'Projects',
          data:d.bar.data,
          backgroundColor:colors.brand.slice(0,d.bar.labels.length),
          borderRadius:8,
          borderSkipped:false
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            callbacks:{label:ctx=>'Projects: '+ctx.parsed.y.toLocaleString('en-IN')}
          }
        },
        scales:{
          y:{beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)', drawBorder:false}},
          x:{grid:{display:false, drawBorder:false}}
        }
      }
    });

    pieChart = new Chart(pieCtx, {
      type:'doughnut',
      data:{
        labels:d.pie.labels,
        datasets:[{
          data:d.pie.data,
          backgroundColor:d.pie.labels.length===1?[colors.gradient.brand]:[colors.gradient.brand, colors.gradient.accent],
          borderWidth:3,
          borderColor:'#fff',
          hoverOffset:10
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        cutout:'65%',
        plugins:{
          legend:{
            position:'bottom',
            labels:{
              padding:15,
              font:{size:12, weight:'600'},
              usePointStyle:true,
              pointStyle:'circle'
            }
          },
          tooltip:{
            callbacks:{
              label:ctx=>{
                const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                const pct = ((ctx.parsed/total)*100).toFixed(1);
                return ctx.label+': '+ctx.parsed.toLocaleString('en-IN')+' ('+pct+'%)';
              }
            }
          }
        }
      }
    });

    lineChart = new Chart(lineCtx, {
      type:'line',
      data:{
        labels:d.line.labels,
        datasets:[{
          label:'Project',
          data:d.line.data,
          borderColor:colors.gradient.brand,
          backgroundColor:colors.gradient.brandLight,
          borderWidth:3,
          tension:0.4,
          fill:true,
          pointRadius:6,
          pointHoverRadius:8,
          pointBackgroundColor:'#fff',
          pointBorderColor:colors.gradient.brand,
          pointBorderWidth:3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            callbacks:{label:ctx=>'Project: '+ctx.parsed.y.toLocaleString('en-IN')}
          }
        },
        scales:{
          y:{beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)', drawBorder:false}},
          x:{grid:{display:false, drawBorder:false}}
        }
      }
    });
  }

  /* ---------- table ---------- */
  function renderTable(){
    const d = getData();
    const live = d.rows.filter(r=>r.status==='Live').length;
    const testing = d.rows.filter(r=>r.status==='Testing').length;
    document.getElementById('liveCount').textContent = live+' Live';
    document.getElementById('testingCount').textContent = testing+' Testing';
    document.getElementById('rowCount').textContent = d.rows.length;
    document.getElementById('detailTableBody').innerHTML = d.rows.map((r,idx)=>
      `<tr class="hover:bg-gray-50 transition-colors table-row" style="animation:fadeIn .3s ease-in ${idx*.03}s both;">
        <td class="px-4 py-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-brand-100 to-accent-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fas fa-cog text-brand-600"></i></div>
            <span class="font-semibold text-gray-800">${r.process}</span>
          </div>
        </td>
        <td class="px-4 py-4">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${r.owner.charAt(0).toUpperCase()}</div>
            <span class="text-gray-700 font-medium">${r.owner}</span>
          </div>
        </td>
        <td class="px-4 py-4 text-right"><span class="font-semibold text-gray-800">${(r.Department).toLocaleString('en-IN')}</span></td>
        <td class="px-4 py-4 text-right"><span class="font-bold text-brand-600">${Number(r.hrsSaved).toLocaleString('en-IN')}</span></td>
        <td class="px-4 py-4 text-right">
          <div class="flex items-center justify-end gap-2">
            <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full" style="width:${r.accuracy}%"></div></div>
            <span class="font-semibold text-gray-700">${r.accuracy}%</span>
          </div>
        </td>
        <td class="px-4 py-4 text-center">
          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold border ${r.status==='Live'?'bg-green-100 text-green-700 border-green-200':'bg-amber-100 text-amber-700 border-amber-200'}">
            <span class="w-2 h-2 ${r.status==='Live'?'bg-green-500':'bg-amber-500'} rounded-full animate-pulse"></span>${r.status}
          </span>
        </td>
      </tr>`
    ).join('');
  }

  /* ---------- sort ---------- */
  window.sortTable = function(col){
    const key = {Department:'Department', hrsSaved:'hrsSaved', accuracy:'accuracy'}[col];
    sortDirection[col] = sortDirection[col]==='desc'?'asc':'desc';
    const dir = sortDirection[col];
    filteredRows.sort((a,b)=>{
      const va = a[key], vb = b[key];
      if(typeof va==='string') return dir==='desc'?vb.localeCompare(va):va.localeCompare(vb);
      return dir==='desc'?vb-va:va-vb;
    });
    renderTable();
  };

  /* ---------- search + status ---------- */
  function applyFilters(){
    const search = document.getElementById('searchTable').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    filteredRows = allRows.filter(r=>{
      const mSearch = r.process.toLowerCase().includes(search) || r.owner.toLowerCase().includes(search);
      const mStatus = status==='all' || r.status===status;
      return mSearch && mStatus;
    });
    renderTable();
  }
  document.getElementById('searchTable').addEventListener('input', applyFilters);
  document.getElementById('statusFilter').addEventListener('change', applyFilters);

  /* ---------- user filter ---------- */
  document.getElementById('userFilter').addEventListener('change', function(){
    currentUser = this.value;
    applyFilters();          // re-apply search & status on new owner
    renderKPI();
    renderCharts();
    renderTable();
  });

  /* ---------- initial draw ---------- */
  renderKPI();
  renderCharts();
  renderTable();

  /* ---------- scroll fade ---------- */
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        e.target.style.opacity='1';
        e.target.style.transform='translateY(0)';
      }
    });
  }, {threshold:.1});
  document.querySelectorAll('section').forEach(s=>{
    s.style.opacity='0';
    s.style.transform='translateY(20px)';
    s.style.transition='all .6s ease-out';
    obs.observe(s);
  });
});
</script>
{% endblock %}
